# SPDX-FileCopyrightText: 2025 The HERACLES++ development team, see COPYRIGHT.md file
#
# SPDX-License-Identifier: MIT

---
name: Build cache on Ubuntu

# yamllint disable-line rule:truthy
on:
  pull_request:
    paths:
      - '.github/workflows/buildcache.yaml'

permissions:
  contents: read

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4
  CMAKE_BUILD_TYPE: Release
  CMAKE_GENERATOR: Ninja

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Spack
        uses: spack/setup-spack@5ab3c91bdefffffad9a7e45d1d156146afebb3a7  # 2.1.1
        with:
          ref: v0.23.1      # Spack version (examples: develop, releases/v0.21)
          buildcache: true  # Configure oci://ghcr.io/spack/github-actions-buildcache
          color: true       # Force color output (SPACK_COLOR=always)
          path: spack       # Where to clone Spack

      - name: Install
        run: spack --env . install

      - name: Run
        shell: spack-bash {0}
        run: |
          spack env activate .
          python3 -c 'print("hello world")'

      - name: Push packages and update index
        env:
          GITHUB_USER: ${{github.actor}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: spack --env . buildcache push --base-image ubuntu:24.04 --update-index local-buildcache
        if: ${{!cancelled()}}
