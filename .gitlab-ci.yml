image:
  name: ghcr.io/maison-de-la-simulation/nova:latest

variables:
  CMAKE_BUILD_PARALLEL_LEVEL: 2
  CMAKE_BUILD_TYPE: Release
  CMAKE_GENERATOR: Ninja
  GIT_DEPTH: 1

before_script:
  - git config --global --add safe.directory $CI_PROJECT_DIR
  - git config --global --add safe.directory $CI_PROJECT_DIR/vendor/kokkos

stages:
  - env
  - lint
  - build
  - test
  - deploy

env-job:common:gtest:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: env
  needs: []
  variables:
    GIT_SUBMODULE_DEPTH: 1
    GIT_SUBMODULE_PATHS: vendor/googletest
    GIT_SUBMODULE_STRATEGY: normal
    GIT_SUBMODULE_UPDATE_FLAGS: --jobs 2
  script:
    - cmake -B build -S vendor/googletest
    - cmake --build build
    - cmake --install build --prefix $CI_PROJECT_DIR/opt/gtest
  artifacts:
    expire_in: 1h
    paths:
      - opt/gtest

env-job:common:inih:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: env
  needs: []
  script:
    - cmake -B build -S vendor/inih
    - cmake --build build
    - cmake --install build --prefix $CI_PROJECT_DIR/opt/inih
  artifacts:
    expire_in: 1h
    paths:
      - opt/inih

env-job:cuda:kokkos:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: env
  needs: []
  variables:
    CXX: $CI_PROJECT_DIR/vendor/kokkos/bin/nvcc_wrapper
    GIT_SUBMODULE_DEPTH: 1
    GIT_SUBMODULE_PATHS: vendor/kokkos
    GIT_SUBMODULE_STRATEGY: normal
    GIT_SUBMODULE_UPDATE_FLAGS: --jobs 2
    NVCC_WRAPPER_DEFAULT_COMPILER: g++-13
  script:
    - cmake -DCMAKE_CXX_EXTENSIONS=OFF -DKokkos_ENABLE_SERIAL=ON -DKokkos_ENABLE_CUDA=ON -DKokkos_ARCH_AMPERE80=ON -DKokkos_ENABLE_DEPRECATED_CODE_4=OFF -DKokkos_ENABLE_DEPRECATION_WARNINGS=OFF -DKokkos_ENABLE_COMPILER_WARNINGS=ON -B build -S vendor/kokkos
    - cmake --build build
    - cmake --install build --prefix $CI_PROJECT_DIR/opt/kokkos
  artifacts:
    expire_in: 1h
    paths:
      - opt/kokkos

env-job:hip:kokkos:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: env
  needs: []
  variables:
    CXX: hipcc
    GIT_SUBMODULE_DEPTH: 1
    GIT_SUBMODULE_PATHS: vendor/kokkos
    GIT_SUBMODULE_STRATEGY: normal
    GIT_SUBMODULE_UPDATE_FLAGS: --jobs 2
  script:
    - cmake -DKokkos_ENABLE_SERIAL=ON -DKokkos_ENABLE_HIP=ON -DKokkos_ENABLE_ROCTHRUST=OFF -DKokkos_ARCH_AMD_GFX90A=ON -DKokkos_ENABLE_DEPRECATED_CODE_4=OFF -DKokkos_ENABLE_DEPRECATION_WARNINGS=OFF -DKokkos_ENABLE_COMPILER_WARNINGS=ON -B build -S vendor/kokkos
    - cmake --build build
    - cmake --install build --prefix $CI_PROJECT_DIR/opt/kokkos
  artifacts:
    expire_in: 1h
    paths:
      - opt/kokkos

env-job:serial:kokkos:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: env
  needs: []
  variables:
    GIT_SUBMODULE_DEPTH: 1
    GIT_SUBMODULE_PATHS: vendor/kokkos
    GIT_SUBMODULE_STRATEGY: normal
    GIT_SUBMODULE_UPDATE_FLAGS: --jobs 2
  script:
    - cmake -DKokkos_ENABLE_SERIAL=ON -DKokkos_ENABLE_DEPRECATED_CODE_4=OFF -DKokkos_ENABLE_DEPRECATION_WARNINGS=OFF -DKokkos_ENABLE_DEBUG=ON -DKokkos_ENABLE_DEBUG_DUALVIEW_MODIFY_CHECK=ON -DKokkos_ENABLE_DEBUG_BOUNDS_CHECK=ON -DKokkos_ENABLE_COMPILER_WARNINGS=ON -B build -S vendor/kokkos
    - cmake --build build
    - cmake --install build --prefix $CI_PROJECT_DIR/opt/kokkos
  artifacts:
    expire_in: 1h
    paths:
      - opt/kokkos

build-job:serial:all:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: build
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:serial:kokkos"]
  variables:
    CXXFLAGS: -Werror=all -Werror=extra -Werror=pedantic -pedantic-errors
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - ./test/build_suite_full.py ./test/setups.yaml

build-job:serial:1d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: build
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:serial:kokkos"]
  variables:
    CMAKE_BUILD_TYPE: Debug
    CXXFLAGS: -Werror=all -Werror=extra -Werror=pedantic -pedantic-errors -Werror=old-style-cast -Werror=extra-semi
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - cmake -DBUILD_TESTING=ON -DNovapp_NDIM=1 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build
  artifacts:
    expire_in: 1h
    paths:
      - build
      - bin

build-job:serial:2d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: build
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:serial:kokkos"]
  variables:
    CMAKE_BUILD_TYPE: Debug
    CXXFLAGS: -Werror=all -Werror=extra -Werror=pedantic -pedantic-errors -Werror=old-style-cast -Werror=extra-semi
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - cmake -DBUILD_TESTING=ON -DNovapp_NDIM=2 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build
  artifacts:
    expire_in: 1h
    paths:
      - build
      - bin

build-job:serial:3d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: build
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:serial:kokkos"]
  variables:
    CMAKE_BUILD_TYPE: Debug
    CXXFLAGS: -Werror=all -Werror=extra -Werror=pedantic -pedantic-errors -Werror=old-style-cast -Werror=extra-semi
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - cmake -DBUILD_TESTING=ON -DNovapp_NDIM=3 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build
  artifacts:
    expire_in: 1h
    paths:
      - build
      - bin

build-job:cuda:3d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: build
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:cuda:kokkos"]
  variables:
    CMAKE_BUILD_TYPE: None
    CXX: $CI_PROJECT_DIR/vendor/kokkos/bin/nvcc_wrapper
    CXXFLAGS: -Werror=all -Werror=extra -Werror=all-warnings
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
    NVCC_WRAPPER_DEFAULT_COMPILER: g++-13
  script:
    - cmake -DBUILD_TESTING=ON -DCMAKE_CXX_EXTENSIONS=OFF -DNovapp_NDIM=3 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build

build-job:hip:3d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: build
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:hip:kokkos"]
  variables:
    CMAKE_BUILD_TYPE: None
    CXX: hipcc
    CXXFLAGS: -Werror=all -Werror=extra -Werror=pedantic -pedantic-errors -Werror=old-style-cast -Werror=extra-semi
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - cmake -DBUILD_TESTING=ON -DNovapp_NDIM=3 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build

unit-test-job:serial:1d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: test
  needs: ["build-job:serial:1d"]
  script:
    - ctest --test-dir build --output-on-failure --timeout 5 --output-junit tests.xml
  artifacts:
    when: always
    reports:
      junit: build/tests.xml

unit-test-job:serial:2d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: test
  needs: ["build-job:serial:2d"]
  script:
    - ctest --test-dir build --output-on-failure --timeout 5 --output-junit tests.xml
  artifacts:
    when: always
    reports:
      junit: build/tests.xml

unit-test-job:serial:3d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: test
  needs: ["build-job:serial:3d"]
  script:
    - ctest --test-dir build --output-on-failure --timeout 5 --output-junit tests.xml
  artifacts:
    when: always
    reports:
      junit: build/tests.xml

convergence-advection-sinusoide-test-job:serial:1d:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: test
  needs: ["build-job:serial:1d"]
  script:
    - ./test/convergence_advection_sinus/run_convergence_advection_sinus.py

clang-format-job:
  rules:
    - when: never
  stage: lint
  needs: []
  script:
    - find src tests -name '*.[h|c]pp' -exec clang-format --dry-run --ferror-limit=10 --Werror '{}' '+'

cmake-format-job:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    DEBIAN_FRONTEND: noninteractive
    GERSEMI_VERSION: 0.18
  stage: lint
  needs: []
  image: ubuntu:latest
  before_script:
    - apt-get --yes update
    - apt-get --yes install --no-install-recommends --no-install-suggests python3-pip python3-venv
    - python3 -m venv ./gersemi
    - . ./gersemi/bin/activate
    - python3 -m pip install gersemi==$GERSEMI_VERSION
  script:
    - find CMakeLists.txt src tests -name 'CMakeLists.txt' -exec gersemi --check '{}' '+'

clang-tidy-job:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: lint
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:serial:kokkos"]
  variables:
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - cmake -DBUILD_TESTING=ON -DCMAKE_CXX_COMPILER=clang++-18 -DCMAKE_CXX_CLANG_TIDY="clang-tidy-18;-header-filter=$CI_PROJECT_DIR/src/.*;-warnings-as-errors=*" -DNovapp_NDIM=3 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build

link-what-you-use-job:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: lint
  needs: ["env-job:common:gtest", "env-job:common:inih", "env-job:serial:kokkos"]
  variables:
    GTest_ROOT: $CI_PROJECT_DIR/opt/gtest
    inih_ROOT: $CI_PROJECT_DIR/opt/inih
    Kokkos_ROOT: $CI_PROJECT_DIR/opt/kokkos
  script:
    - cmake -DBUILD_TESTING=ON -DCMAKE_CXX_COMPILER=clang++-18 -DCMAKE_LINK_WHAT_YOU_USE=ON -DNovapp_NDIM=3 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DNovapp_GTest_DEPENDENCY_POLICY=INSTALLED -DNovapp_inih_DEPENDENCY_POLICY=INSTALLED -DNovapp_Kokkos_DEPENDENCY_POLICY=INSTALLED -B build
    - cmake --build build

trailing-whitespaces-job:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: lint
  needs: []
  script:
    - find src tests inputs -type f \( -name '*.[c|h]pp' -o -name 'CMakeLists.txt' \) -exec ./test/trailing_spaces.py --Werror '{}' '+'

ini-validation-job:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    DEBIAN_FRONTEND: noninteractive
    VALIDATOR_VERSION: 1.8.0
  stage: lint
  needs: []
  image: ubuntu:latest
  before_script:
    - apt-get --yes update
    - apt-get --yes --no-install-recommends --no-install-suggests install ca-certificates wget
    - mkdir validator
    - VALIDATOR_URL=https://github.com/Boeing/config-file-validator/releases/download/v${VALIDATOR_VERSION}/validator-v${VALIDATOR_VERSION}-linux-amd64.tar.gz
    - wget --quiet --output-document=- $VALIDATOR_URL | tar --directory=validator --gzip --extract
  script:
    - validator/validator inputs

doxygen-job:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  stage: test
  needs: []
  script:
    - cmake -DDOXYGEN_WARN_AS_ERROR=YES -DNovapp_NDIM=3 -DNovapp_SETUP=advection_sinus -DNovapp_EOS=PerfectGas -DNovapp_GEOM=Cartesian -DNovapp_GRAVITY=Uniform -DKokkos_ENABLE_SERIAL=ON -DKokkos_ENABLE_DEPRECATED_CODE_4=OFF -DKokkos_ENABLE_DEPRECATION_WARNINGS=OFF -B build
    - cmake --build build --target doxygen
